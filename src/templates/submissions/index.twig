{% extends "_layouts/cp" %}
{% set title = "Submissions"|t('chatflow') %}
{% set selectedSubnavItem = 'submissions' %}

{% block header %}
    {{ block('pageTitle') }}

    <div class="flex-grow"></div>

    {% if forms|length %}
        <div class="btn menubtn" data-icon="settings">{{ selectedForm ? selectedForm.name : 'All Forms'|t('chatflow') }}</div>
        <div class="menu">
            <ul>
                <li><a href="{{ url('chatflow/submissions') }}" {% if not selectedFormId %}class="sel"{% endif %}>{{ 'All Forms'|t('chatflow') }}</a></li>
                {% for form in forms %}
                    <li><a href="{{ url('chatflow/submissions', {formId: form.id}) }}" {% if selectedFormId == form.id %}class="sel"{% endif %}>{{ form.name }}</a></li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if submissions|length %}
        <form method="post" accept-charset="UTF-8">
            {{ csrfInput() }}
            <input type="hidden" name="action" value="chatflow/submissions/export">
            {% if selectedForm %}
                <input type="hidden" name="formId" value="{{ selectedForm.id }}">
            {% endif %}
            <button type="submit" class="btn">{{ 'Export to CSV'|t('chatflow') }}</button>
        </form>
    {% endif %}
{% endblock %}

{% block content %}
    {% if submissions|length %}
        <div class="tableview">
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th>{{ "ID"|t('chatflow') }}</th>
                        <th>{{ "Form"|t('chatflow') }}</th>
                        <th>{{ "Data"|t('chatflow') }}</th>
                        <th>{{ "Date"|t('chatflow') }}</th>
                        <th class="thin"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for submission in submissions %}
                        {% set submissionForm = craft.chatflow.forms|filter(f => f.id == submission.formId)|first %}
                        <tr data-id="{{ submission.id }}">
                            <td>
                                <a href="{{ url('chatflow/submissions/' ~ submission.id) }}">{{ submission.id }}</a>
                            </td>
                            <td>
                                {{ submissionForm ? submissionForm.name : 'Unknown' }}
                            </td>
                            <td>
                                {% set data = submission.data %}
                                {% if data is iterable and data %}
                                    {% if data.name is defined %}
                                        {{ data.name }}
                                    {% elseif data.email is defined %}
                                        {{ data.email }}
                                    {% else %}
                                        {{ data|keys|first }}: {{ data|first }}
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {{ submission.dateCreated|date('M j, Y g:i A') }}
                            </td>
                            <td class="thin">
                                <a class="delete icon" title="{{ 'Delete'|t('app') }}" role="button"></a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>{{ "No submissions yet."|t('chatflow') }}</p>
    {% endif %}
{% endblock %}

{% js %}
    $(document).on('click', '.delete', function(e) {
        e.preventDefault();
        var $row = $(this).closest('tr');
        var id = $row.data('id');

        if (confirm('Are you sure you want to delete this submission?')) {
            Craft.sendActionRequest('POST', 'chatflow/submissions/delete', {
                data: {id: id}
            }).then(function(response) {
                if (response.data.success) {
                    $row.remove();
                    Craft.cp.displayNotice('Submission deleted.');
                }
            });
        }
    });
{% endjs %}
